<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Running standard services with Docker | opiation.github.io</title>
<meta property="og:title" content="Running standard services with Docker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A little context" />
<meta property="og:description" content="A little context" />
<link rel="canonical" href="http://localhost:4000/docker-for-work/2017/09/15/docker-with-stock-services.html" />
<meta property="og:url" content="http://localhost:4000/docker-for-work/2017/09/15/docker-with-stock-services.html" />
<meta property="og:site_name" content="opiation.github.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-15T00:00:00-04:00" />
<script type="application/ld+json">
{"name":null,"description":"A little context","author":null,"@type":"BlogPosting","url":"http://localhost:4000/docker-for-work/2017/09/15/docker-with-stock-services.html","publisher":null,"image":null,"headline":"Running standard services with Docker","dateModified":"2017-09-15T00:00:00-04:00","datePublished":"2017-09-15T00:00:00-04:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/docker-for-work/2017/09/15/docker-with-stock-services.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=37019e7333bc210bcd184f97759c929db270aca1">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">opiation.github.io</h1>
      <h2 class="project-tagline"></h2>
      
        <a href="http://github.com/opiation/opiation.github.io" class="btn">View on GitHub</a>
      
      
    </section>

    <section class="main-content">
      <h2 id="a-little-context">A little context</h2>

<p>Applications usually require significant customization to interact with a plethora of different services and components.  As such, they are most often shipped in their own docker image.  Services like reverse, proxies, caches and databases however are often run from <em>official</em> or <em>stock</em> docker images.  Many services like nginx, postgres, etc. don’t requre one to build custom container images.  They come ready made and only require a little configuration to work for you.</p>

<hr />

<h1 id="deploying-a-reverse-proxy-with-docker">Deploying a reverse proxy with docker</h1>

<p>In this section, we’ll be deploying a reverse proxy (<a href="https://hub.docker.com/_/nginx/">NGINX</a>) as a container to proxy requests it receives on port <strong>80</strong> to 1 of 2 application servers depending on the request URL.  Requests to <strong>staging.example.com</strong> will be proxied to the host running the staging application server and <strong>www.example.com</strong> will to proxied to the production host.</p>

<h4 id="tools-and-skills-youll-need">Tools and skills you’ll need</h4>
<ul>
  <li>Docker CE installed on your system</li>
  <li>Familiarity with NGINX <strong>conf</strong> files</li>
</ul>

<h4 id="the-assumptions-well-make">The assumptions we’ll make</h4>

<p>The host where NGINX will run must be your own machine or one that is otherwise accessible to you via SSH.  The staging and production application servers must be accessible to the host running NGINX.  IPs are provided but are arbitrary.  Substitute them for your own accordingly.</p>

<ul>
  <li>NGINX is will run on host <strong>10.12.7.3</strong> and will receive requests from port <strong>8080</strong> of that host</li>
  <li>Staging server is running on host <strong>10.12.7.17</strong> and bound to port <strong>3001</strong></li>
  <li>Production server us running host <strong>10.12.7.99</strong> and bound to port <strong>3000</strong></li>
</ul>

<p>Find below a minimal network diagram demonstrating the relationship between hosts.</p>

<pre><code class="language-mermaid">graph TB
  nginx["&lt;center&gt;&lt;b&gt;Nginx&lt;/b&gt;&lt;br /&gt;10.12.7.3:8080&lt;/center&gt;"] --staging.example.com--&gt; staging("&lt;center&gt;&lt;b&gt;Staging server&lt;/b&gt;&lt;br /&gt;10.12.7.17:3000&lt;/center&gt;")
  nginx --www.example.com--&gt; production("&lt;center&gt;&lt;b&gt;Production server&lt;/b&gt;&lt;br /&gt;10.12.7.99:3000&lt;/center&gt;")
</code></pre>

<h2 id="our-reverse-proxy-configuration">Our reverse proxy configuration</h2>

<p>There is more than one way with NGINX to route requests to different hosts.  In our case, given the relative simplicity of our network, we’ve opted for defining 2 servers, one for each application server.</p>

<p>Our staging server in NGINX must accept requests destined for <strong>staging.example.com</strong> and forward them to <strong>10.12.7.17:3001</strong>.</p>
<div class="language-nginx highlighter-rouge"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
  <span class="c1"># The host to which this NGINX server should respond
</span>  <span class="kn">server_name</span> <span class="s">staging.example.com</span><span class="p">;</span>

  <span class="c1"># / will apply this location block to all request paths
</span>  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="c1"># Proxy request to this host:port
</span>    <span class="kn">proxy_pass</span> <span class="s">http://10.12.7.17:3001</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Our production server in NGINX must accept requests destined for <strong>www.example.com</strong> and forward them to <strong>10.12.7.99:3000</strong>.</p>

<div class="language-nginx highlighter-rouge"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
  <span class="kn">server_name</span> <span class="s">www.example.com</span><span class="p">;</span>
  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://10.12.7.99:3000</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="our-complete-nginx-configuration">Our complete NGINX configuration</h4>
<p>Find below the complete NGINX configuration we need to achieve our goals.  It’s quite thin but does the job.  For more robust configurations, we might include HTTPS redirects, serving static content, logging, etc.  For more information on building thorough NGINX configs, consult the <a href="http://nginx.org/en/docs/">NGINX documentation</a>.</p>

<div class="language-nginx highlighter-rouge"><pre class="highlight"><code><span class="c1"># /home/opiation/nginx.conf
</span>
<span class="k">http</span> <span class="p">{</span>
  <span class="c1"># Staging server
</span>  <span class="kn">server</span> <span class="p">{</span>
    <span class="kn">server_name</span> <span class="s">staging.example.com</span><span class="p">;</span>
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
      <span class="kn">proxy_pass</span> <span class="s">http://10.12.7.17:3001</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Production server
</span>  <span class="kn">server</span> <span class="p">{</span>
    <span class="kn">server_name</span> <span class="s">www.example.com</span><span class="p">;</span>
    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
      <span class="kn">proxy_pass</span> <span class="s">http://10.12.7.99:3000</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="deploying-the-nginx-container">Deploying the NGINX container</h2>
<p>We now have what we need to deploy an NGINX container.</p>

<p>TODO: Include details about each <code class="highlighter-rouge">docker run</code> option used</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># deploy-nginx-container.sh</span>

docker run <span class="se">\</span>
  --detach
  --name<span class="o">=</span>nginx-container
  --publish<span class="o">=</span>0.0.0.0:8080:80
  --volume<span class="o">=</span><span class="nv">$PWD</span>/nginx.conf:/etc/nginx/nginx.conf:ro
  nginx:1.13-alpine
</code></pre>
</div>

<script src="https://unpkg.com/mermaid@7.1.0/dist/mermaid.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        mermaid.init(undefined, ".language-mermaid");

        var mermaid_code_elements = document.querySelectorAll("code.language-mermaid");
        for (var code_index = 0; code_index < mermaid_code_elements.length; code_index += 1) {
            var code_element = mermaid_code_elements[code_index];
            var parent_pre_element = code_element.parentNode;
            var svgs = code_element.querySelectorAll("svg");
            for (var svg_index = 0; svg_index < svgs.length; svg_index += 1) {
                parent_pre_element.parentNode.insertBefore(svgs[svg_index], parent_pre_element);
            }
            parent_pre_element.parentNode.removeChild(parent_pre_element);
        }
    });
</script>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="http://github.com/opiation/opiation.github.io">opiation.github.io</a> is maintained by <a href="http://github.com/opiation">opiation</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </section>

    
  </body>
</html>
